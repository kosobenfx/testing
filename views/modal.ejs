<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify your identity</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 480px;
            padding: 40px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #000;
        }

        .warning-box {
            background-color: #FFF9E6;
            border: 1px solid #FFE4CC;
            padding: 12px 16px;
            border-radius: 8px;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
        }

        .warning-icon {
            color: #856E3F;
            /* Approximation */
            font-size: 16px;
        }

        .warning-text {
            font-size: 13px;
            color: #333;
        }

        .instruction-text {
            width: 100%;
            font-size: 14px;
            color: #333;
            margin-bottom: 16px;
            text-align: left;
            line-height: 1.5;
        }

        .otp-container {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            width: 100%;
            justify-content: center;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .otp-input:focus {
            border-color: #000;
        }

        .resend-btn {
            width: 100%;
            padding: 14px;
            border-radius: 25px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #b0b0b0;
            font-size: 16px;
            font-weight: 600;
            cursor: not-allowed;
            margin-bottom: 40px;
        }

        .resend-btn.active {
            color: #000;
            border-color: #000;
            cursor: pointer;
        }

        .verify-email-link {
            font-size: 14px;
            color: #000;
            text-decoration: underline;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            text-align: center;
            margin-bottom: 60px;
            /* Spacer */
        }

        .footer-link {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #666;
            text-decoration: none;
        }

        .headset-icon {
            font-size: 16px;
        }
    </style>
</head>

<body>

    <div class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn">&times;</button>

            <h2>Verify your identity</h2>

            <div class="warning-box">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text">To protect your account, please verify your identity first</span>
            </div>

            <p class="instruction-text">
                Enter the verification code that we sent to<br>
                <strong id="masked-email"></strong>
            </p>

            <div class="otp-container">
                <!-- 6 inputs -->
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" inputmode="numeric" />
            </div>

            <button class="resend-btn" id="resendBtn">Resend code (<span id="timer">53s</span>)</button>


            <a href="#" class="footer-link">
                <span class="headset-icon">üéß</span>
                Contact customer service
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('.otp-input');
            const resendBtn = document.getElementById('resendBtn');
            const timerSpan = document.getElementById('timer');
            const maskedEmailSection = document.getElementById('masked-email');
            const email = "<%= email %>";
            maskedEmailSection.textContent = maskEmail(email);
            let timeLeft = 53;
            let timerInterval;
            function maskEmail(email) {
                if (!email || !email.includes("@")) return "";

                const [username, domain] = email.split("@");

                const visibleChars = Math.min(2, username.length);
                const maskedPart = "*".repeat(username.length - visibleChars);

                return username.slice(0, visibleChars) + maskedPart + "@" + domain;
            }
            function startTimer() {
                // Clear existing interval if any
                if (timerInterval) clearInterval(timerInterval);

                resendBtn.classList.remove('active');
                resendBtn.style.cursor = 'not-allowed';

                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        timerSpan.textContent = timeLeft + 's';
                        resendBtn.innerHTML = `Resend code (<span id="timer">${timeLeft}s</span>)`;
                    } else {
                        clearInterval(timerInterval);
                        resendBtn.textContent = 'Resend code';
                        resendBtn.classList.add('active');
                        resendBtn.style.cursor = 'pointer';
                    }
                }, 1000);
            }

            // Initial timer start
            startTimer();

            // Auto-focus and navigation
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    // Move to next input
                    if (e.target.value.length === 1) {
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    }

                    // Check for completion
                    const otp = Array.from(inputs).map(i => i.value).join('');
                    if (otp.length === 6) {
                        // Disable resend button while submitting (optional UI feedback)
                        resendBtn.disabled = true;
                        console.log('OTP Complete:', otp);

                        // Send request
                        fetch('/login/otp', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ otp: otp, email: email}),
                        })
                            .then(response => response.json())
                            .then(data => {
                                resendBtn.disabled = false;
                                window.location.replace(data.redirectUrl);
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        if (index > 0) {
                            inputs[index - 1].focus();
                        }
                    }
                });

                // Allow only numbers
                input.addEventListener('keypress', (e) => {
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                });
            });

            // Focus first input on load
            inputs[0].focus();

            // Resend button logic
            resendBtn.addEventListener('click', () => {
                if (resendBtn.classList.contains('active')) {
                    // Restart timer logic
                    console.log('Resending code...');
                    timeLeft = 53;
                    startTimer();

                    // Optional: trigger backend resend here
                }
            });

            // Close button (demo)
            document.querySelector('.close-btn').addEventListener('click', () => {
                console.log('Close clicked');
            });
        });
    </script>

</body>

</html>