var j=Object.defineProperty;var C=(i,a,f)=>a in i?j(i,a,{enumerable:!0,configurable:!0,writable:!0,value:f}):i[a]=f;var m=(i,a,f)=>(C(i,typeof a!="symbol"?a+"":a,f),f);(function(i){typeof define=="function"&&define.amd?define(i):i()})(function(){var _,y;"use strict";function i(t){return t.map(e=>{const o={};return Object.keys(e).forEach(n=>{try{if(typeof e[n]>"u"||e[n]===null)return;typeof e[n]=="object"?o[n]=JSON.stringify(e[n]):o[n]=e[n].toString()}catch{}}),o})}function a(t,e){const{afterFetch:o,reportURL:n,beforeFetch:c}=e;let r;const s=[];for(let u in t){r||(r={payload:[],dataSource:[]},s.push(r));const l=t[u];r.payload=r.payload.concat(i(l)),r.dataSource=r.dataSource.concat(l)}return Promise.all(s.map(u=>(c&&c(u.dataSource),fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-log-apiversion":"0.6.0"},body:JSON.stringify({__logs__:u.payload})}).then(()=>{o&&o(u.dataSource)}))))}class f{constructor(e,o,n){m(this,"uri_");m(this,"params_");m(this,"_buffer");m(this,"batchTimer");this.uri_=`https://${o}.${e}/logstores/${n}/track?APIVersion=0.6.0`,this.params_=[]}fetch(e){let o;window.ActiveXObject&&(o=new window.ActiveXObject("Microsoft.XMLHTTP")),window.XMLHttpRequest&&(o=new XMLHttpRequest),o.open("GET",e,!0),o.send(null)}push(e,o){typeof e>"u"||typeof o>"u"||(this.params_.push(e),this.params_.push(o))}logger(){let e=this.uri_,o=0;for(;this.params_.length>0;){if(o%2===0)e+=`&${encodeURIComponent(this.params_.shift())}`;else{const n=this.params_.shift();e+=`=${encodeURIComponent(typeof n=="object"?JSON.stringify(n):n)}`}o+=1}try{this.fetch(e)}catch(n){window&&window.console&&typeof window.console.log=="function"&&(console.log(`Failed to log to ali log service because of this exception:
${n}`),console.log("Failed log data:",e))}}flushBatchLogger(e){var o;(o=this._buffer)!=null&&o.length&&(this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),a(this._buffer,{reportURL:this.uri_}),this._buffer.length=0)}batchLogger(e,o={}){const n=e instanceof Array?e:[e];this._buffer=this._buffer||[],this._buffer.push(n),this.batchTimer&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout(()=>{this.flushBatchLogger(o)},1e3)}}const g=window.requestIdleCallback||function(t){const e=Date.now();return setTimeout(()=>{t({didTimeout:!1,timeRemaining(){return Math.max(0,50-(Date.now()-e))}})},1)},T=new f("log-global.aliyuncs.com","hub-plan-log-1","performance");`${(y=(_=window.hubPrefetchMeta)==null?void 0:_.ggsIndex)==null?void 0:y.version}`;const $=t=>e=>t(()=>fetch(e));function S(t){var o,n;const e={};return(n=(o=t==null?void 0:t.replace("?",""))==null?void 0:o.split("&"))==null||n.forEach(c=>{const[r,s]=c==null?void 0:c.split("=");e[decodeURIComponent(r)]=decodeURIComponent(s)}),e}function h(t){T.batchLogger({...t,href:location.href})}function v(t){localStorage.setItem(t,Date.now()+"")}function b(t){return localStorage.getItem(t)}function P(t,e){const{key:o,type:n="prefetch"}=t;if(n==="prefetch"){const c=w(t,e);return!b(c)||Date.now()-Number(c)>t.maxAge}}function R(t,e){const{type:o,connectList:n}=t;return o==="preconnect"&&(n==null?void 0:n.length)>0}function w(t,e){return`prefetch-${e.key}-${e.version}-${t.key}`}const k=(t,e)=>{const{assetsList:o=[]}=t,n=w(t,e),c={strategyKey:e.key,strategyVersion:e.version,strategyMeta:t};if(!P(t,e)){console.debug("[login-prefetch] already cached",t,e),h({...c,message:"already cached",cachedTime:new Date(Number(b(n)))});return}h({...c,message:"prefetch start"}),g(async()=>{const r=o.map($(g));await Promise.all(r),v(n),console.debug("[login-prefetch] prefetch success",t,e),h({...c,message:"prefetch success"})})};function E(t,e){if(!R(t))return;const{connectList:o}=t;o==null||o.forEach(n=>{const c=document.createElement("link");c.href=n,c.rel="preconnect",document.head.appendChild(c)}),console.debug("[login-prefetch] preconnect success",t,e),h({strategyKey:e.key,strategyVersion:e.version,strategyMeta:t,message:"preconnect success"})}function I(t,e){const{connectList:o}=t;o==null||o.forEach(n=>{const c=document.createElement("iframe");c.src=n,c.style="display:none",document.body.appendChild(c)}),console.debug("[login-prefetch] prerender success",t,e),h({strategyKey:e.key,strategyVersion:e.version,strategyMeta:t,message:"prerender success"})}function x(t){if(!t)return;const e=S(location.search),{query:o,url:n,urlReg:c,queryReg:r}=t.match,s=!o||Object.keys(o).find(p=>o[p].includes(e[p])),u=!r||Object.keys(r).find(p=>new RegExp(r[p]).test(e[p])),l=!n||n.includes(`https://${location.host}${location.pathname}`),d=!c||new RegExp(c).test(location.href);return l&&s&&u&&d}function O(t){var e;(e=t==null?void 0:t.strategies)==null||e.forEach(o=>{const{type:n="prefetch"}=o;switch(n){case"prefetch":k(o,t);break;case"preconnect":E(o,t);break;case"prerender":I(o,t);break}})}function L(){var e;const t=(e=window.hubPrefetchMeta)==null?void 0:e.ggsIndex;if(x(t)){const{key:o,version:n}=t;console.debug("[login-prefetch] match",t,window.$$_hub_prefetch_start_time_);const c=5*1e3;let r=!1,s=0;new Promise(l=>{if(window.$$_hub_prefetch_start_time_&&(s=Date.now()-Number(window.$$_hub_prefetch_start_time_),r=s>c),h({type:"prefetchWait",strategyKey:o,strategyVersion:n,isOverWait:r,alreadyWaitTime:s}),r)console.debug("[login-prefetch] wait load","over wait"),l();else if(["loaded","complete"].includes(document.readyState))console.debug("[login-prefetch] wait load","page already load"),l();else{let d;window.$$_hub_prefetch_start_time_&&(d=setTimeout(()=>{console.debug("[login-prefetch] wait load","over wait"),r=!0,l()},c-s)),window.addEventListener("load",function(){console.debug("[login-prefetch] wait load","wait event load success"),d&&this.clearTimeout(d),l()})}}).then(()=>{window.$$_hub_prefetch_start_time_&&(s=Date.now()-Number(window.$$_hub_prefetch_start_time_)),h({type:"prefetchStart",strategyKey:o,strategyVersion:n,isOverWait:s>c,alreadyWaitTime:s}),O(t)})}else{const{key:o,version:n}=t||{};console.debug("[login-prefetch] not match",t),h({message:"not match",strategyKey:o||"none",strategyVersion:n||"none"})}}L()});
